name: Build SelfControl

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:  # Allows manual trigger from any branch

jobs:
  build:
    name: Build SelfControl
    runs-on: macos-14  # Use stable macOS 14 (Sonoma) instead of latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: false  # We'll init submodules manually due to stale commit ref

      - name: Initialize Submodules
        run: |
          # The submodule references a commit that may not exist anymore
          # Clone the ArgumentParser repo and checkout the latest from master
          git submodule update --init --recursive || {
            echo "Submodule update failed, cloning fresh..."
            rm -rf ArgumentParser
            git clone --depth 1 https://github.com/mysteriouspants/ArgumentParser.git ArgumentParser
          }

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods
          gem install cocoapods-prune-localizations
          gem install xcpretty

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/CocoaPods
            Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install Pods
        run: pod install

      - name: Install Sparkle Framework
        run: |
          # Sparkle.framework is in .gitignore, so we need to download it for CI
          # Download latest Sparkle 2.x release
          SPARKLE_VERSION="2.6.4"
          curl -L -o Sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-${SPARKLE_VERSION}.tar.xz"
          mkdir -p Sparkle-temp
          tar -xf Sparkle.tar.xz -C Sparkle-temp
          # Copy the framework to project root (where Xcode project expects it)
          cp -R Sparkle-temp/Sparkle.framework .
          rm -rf Sparkle-temp Sparkle.tar.xz
          echo "Sparkle.framework installed"
          ls -la Sparkle.framework/

      - name: Create Secrets Config
        run: |
          # Create dummy Secrets.xcconfig for CI builds
          # For production builds, use GitHub Secrets to inject real values
          echo "// CI Build Secrets" > Secrets.xcconfig
          echo "LICENSE_SECRET_KEY = 0000000000000000000000000000000000000000000000000000000000000000" >> Secrets.xcconfig

      - name: Run Setup Script
        run: |
          chmod +x scripts/setup_macos26.sh
          ./scripts/setup_macos26.sh

      - name: Select Xcode
        run: |
          # List available Xcode versions
          ls /Applications | grep Xcode
          # Use Xcode 15.4 if available, otherwise use default
          if [ -d "/Applications/Xcode_15.4.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer
          fi
          xcodebuild -version

      - name: Build
        run: |
          xcodebuild -workspace SelfControl.xcworkspace \
            -scheme SelfControl \
            -configuration Debug \
            -destination 'platform=macOS,arch=arm64' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build

      - name: Build CLI
        run: |
          xcodebuild -workspace SelfControl.xcworkspace \
            -scheme selfcontrol-cli \
            -configuration Debug \
            -destination 'platform=macOS,arch=arm64' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=YES \
            CODE_SIGNING_ALLOWED=YES \
            COMPILER_INDEX_STORE_ENABLE=NO \
            build

      - name: Fix Permissions
        run: |
          # Ensure the binary inside the app bundle is executable
          chmod +x "build/Build/Products/Debug/Fence.app/Contents/MacOS/Fence"
          echo "Permissions fixed"

      - name: Create DMG
        run: |
          # Create a temporary directory for the DMG contents
          mkdir -p dmg_root
          # Copy the .app into it
          cp -R "build/Build/Products/Debug/Fence.app" dmg_root/
          # Create the DMG
          hdiutil create -volname "Fence" -srcfolder dmg_root -ov -format UDZO Fence.dmg
          echo "DMG created at Fence.dmg"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Fence.dmg
          path: Fence.dmg
